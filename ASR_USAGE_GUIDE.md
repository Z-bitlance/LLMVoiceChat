# 语音对话系统使用指南（升级版）

本文档介绍了添加了实时语音识别和AI语音打断功能的语音对话系统的使用方法。

## 系统特点

- **实时语音识别**：系统能够实时将您的语音转换为文字
- **AI语音打断**：您可以通过语音或点击按钮随时打断AI的回复
- **多角色对话**：支持多种角色，如助手、教师、医生等
- **高质量语音合成**：使用先进的语音合成技术，提供自然流畅的语音回复

## 启动系统

### Windows用户

1. 打开命令提示符或PowerShell
2. 导航到系统根目录
3. 运行 `start_with_asr.bat`

### Linux/Mac用户

1. 打开终端
2. 导航到系统根目录
3. 确保脚本有执行权限：`chmod +x start_with_asr.sh`
4. 运行 `./start_with_asr.sh`

## 使用方法

1. **访问前端页面**：在浏览器中打开 `http://localhost:3000`

2. **选择角色**：在页面顶部选择一个对话角色（助手、教师、医生等）

3. **开始对话**：
   - **文本输入**：在底部输入框中输入文字，然后按发送按钮或回车键
   - **语音输入**：点击麦克风按钮开始语音输入，说完后再次点击或自动结束

4. **AI语音打断功能**：
   - 当AI正在回答时，您可以通过以下方式打断：
     - **语音打断**：直接开始说话，系统会检测到并停止AI回复
     - **按钮打断**：点击界面上的"打断"按钮立即停止AI回复

## 系统配置

### 调整语音识别灵敏度

可以编辑 `voice-chat-web/backend/core/dialogue_manager_new.py` 文件中的以下参数：

```python
# 静音阈值，值越小灵敏度越高
silence_threshold = 4500  

# 沉默持续多久后结束识别（秒）
silence_duration = 1.0  
```

### 配置语音合成角色

可以在角色配置中设置不同的语音，目前支持：

- `longxiang`：男声，沉稳
- `xiaoyun`：女声，柔和
- `aixia`：女声，专业
- `ruoxi`：女声，活泼
- `sijia`：女声，自然

## 常见问题

1. **无法识别语音？**
   - 检查麦克风是否正常工作
   - 确保浏览器有麦克风使用权限
   - 尝试调低语音识别阈值以提高灵敏度

2. **语音打断不工作？**
   - 确保说话声音足够大
   - 检查麦克风是否正确配置
   - 可能需要调低`silence_threshold`值

3. **系统无法启动？**
   - 确保所有依赖已安装
   - 检查端口是否被占用
   - 查看后端和前端日志以获取详细错误信息

## API接口说明

### 语音识别相关接口

- `/api/voice/recognize`：处理语音识别请求
- `/api/direct-recognize`：直接模型的语音识别请求

### 其他主要接口

- `/api/chat`：文本聊天接口
- `/api/voice/speak`：语音合成接口
- `/api/roles`：获取支持的角色列表
- `/api/role/set`：设置当前角色
- `/api/interrupt`：中断AI语音输出
- `/api/status`：获取系统状态

## 技术原理

本系统使用了以下技术：

- **ASR**：基于DashScope的实时语音识别技术
- **TTS**：使用CosyVoice语音合成服务
- **语音活动检测**：基于音频音量的实时检测
- **前端框架**：基于Vue.js构建的响应式界面
- **后端API**：使用FastAPI构建的高性能API服务

## 附录

### 依赖项安装

```bash
# 后端依赖
pip install fastapi uvicorn dashscope pydantic requests python-multipart

# 前端依赖
cd voice-web-frontend
npm install
```
